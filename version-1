# MikroTik Inter-VLAN Firewall Rules
# Security-focused configuration with bandwidth limits

# ==========================================
# ADDRESS LISTS - For easy management
# ==========================================
/ip firewall address-list
add address=10.0.10.0/24 list=vlan10-trusted
add address=10.0.20.0/24 list=vlan20-guest
add address=10.0.30.0/24 list=vlan30-iot
add address=10.0.40.0/24 list=vlan40-camera
add address=10.0.50.0/24 list=vlan50-mgmt
add address=172.20.67.0/24 list=vlan67-vpn

# Media server addresses for VLAN 10 access
add address=10.0.50.10 list=media-servers comment="Plex"
add address=10.0.50.20 list=media-servers comment="JellyFin"
add address=10.0.50.30 list=media-servers comment="Overseerr"

# ==========================================
# QUEUE TREE - Bandwidth limits for Guest VLAN
# ==========================================
# First, mark connections from Guest VLAN
/ip firewall mangle
add chain=prerouting src-address=10.0.20.0/24 action=mark-connection new-connection-mark=guest-conn comment="Mark Guest VLAN connections"
add chain=prerouting connection-mark=guest-conn action=mark-packet new-packet-mark=guest-upload comment="Mark Guest upload"
add chain=postrouting dst-address=10.0.20.0/24 action=mark-packet new-packet-mark=guest-download comment="Mark Guest download"

# Create queue tree for bandwidth limiting
/queue tree
add name=guest-download-limit packet-mark=guest-download parent=global max-limit=20M comment="Guest VLAN Download: 20Mbps"
add name=guest-upload-limit packet-mark=guest-upload parent=global max-limit=10M comment="Guest VLAN Upload: 10Mbps"

# ==========================================
# FIREWALL FILTER RULES
# ==========================================

# Drop invalid connections
/ip firewall filter
add chain=forward action=drop connection-state=invalid comment="Drop invalid connections"

# Accept established and related connections
add chain=forward action=accept connection-state=established,related comment="Accept established/related"

# ==========================================
# VLAN 10 (TRUSTED) RULES
# ==========================================
# Allow VLAN 10 to access media servers in MGMT VLAN
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=32400 action=accept comment="VLAN10: Allow Plex access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=8096 action=accept comment="VLAN10: Allow Jellyfin access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=5055 action=accept comment="VLAN10: Allow Overseerr access"

# Block VLAN 10 from rest of MGMT VLAN
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan50-mgmt action=drop comment="VLAN10: Block MGMT VLAN (except media servers)"

# Allow VLAN 10 to access IoT, Camera, and VPN VLANs
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan30-iot action=accept comment="VLAN10: Allow IoT access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan40-camera action=accept comment="VLAN10: Allow Camera access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan67-vpn action=accept comment="VLAN10: Allow VPN access"

# Allow VLAN 10 to internet
add chain=forward src-address-list=vlan10-trusted out-interface-list=WAN action=accept comment="VLAN10: Allow internet"

# Allow VLAN 10 DNS/DHCP to router
add chain=input src-address-list=vlan10-trusted protocol=udp dst-port=53 action=accept comment="VLAN10: Allow DNS"
add chain=input src-address-list=vlan10-trusted protocol=tcp dst-port=53 action=accept comment="VLAN10: Allow DNS TCP"
add chain=input src-address-list=vlan10-trusted protocol=udp dst-port=67 action=accept comment="VLAN10: Allow DHCP"

# Block VLAN 10 from managing router
add chain=input src-address-list=vlan10-trusted action=drop comment="VLAN10: Block router management"

# ==========================================
# VLAN 20 (GUEST) RULES
# ==========================================
# Allow Guest VLAN DNS/DHCP to router
add chain=input src-address-list=vlan20-guest protocol=udp dst-port=53 action=accept comment="VLAN20: Allow DNS"
add chain=input src-address-list=vlan20-guest protocol=tcp dst-port=53 action=accept comment="VLAN20: Allow DNS TCP"
add chain=input src-address-list=vlan20-guest protocol=udp dst-port=67 action=accept comment="VLAN20: Allow DHCP"

# Block Guest from all VLANs
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan10-trusted action=drop comment="VLAN20: Block Trusted VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan30-iot action=drop comment="VLAN20: Block IoT VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan40-camera action=drop comment="VLAN20: Block Camera VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan50-mgmt action=drop comment="VLAN20: Block MGMT VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan67-vpn action=drop comment="VLAN20: Block VPN VLAN"

# Allow Guest to internet only (bandwidth limited via queue)
add chain=forward src-address-list=vlan20-guest out-interface-list=WAN action=accept comment="VLAN20: Allow internet (bandwidth limited)"

# Block Guest from router management
add chain=input src-address-list=vlan20-guest action=drop comment="VLAN20: Block router access"

# ==========================================
# VLAN 30 (IoT) RULES
# ==========================================
# Allow IoT VLAN DNS/DHCP to router
add chain=input src-address-list=vlan30-iot protocol=udp dst-port=53 action=accept comment="VLAN30: Allow DNS"
add chain=input src-address-list=vlan30-iot protocol=tcp dst-port=53 action=accept comment="VLAN30: Allow DNS TCP"
add chain=input src-address-list=vlan30-iot protocol=udp dst-port=67 action=accept comment="VLAN30: Allow DHCP"

# Block IoT from all VLANs
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan10-trusted action=drop comment="VLAN30: Block Trusted VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan20-guest action=drop comment="VLAN30: Block Guest VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan40-camera action=drop comment="VLAN30: Block Camera VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan50-mgmt action=drop comment="VLAN30: Block MGMT VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan67-vpn action=drop comment="VLAN30: Block VPN VLAN"

# Allow IoT to internet only
add chain=forward src-address-list=vlan30-iot out-interface-list=WAN action=accept comment="VLAN30: Allow internet only"

# Block IoT from router management
add chain=input src-address-list=vlan30-iot action=drop comment="VLAN30: Block router access"

# ==========================================
# VLAN 40 (CAMERA) RULES
# ==========================================
# Allow Camera VLAN DNS/DHCP to router
add chain=input src-address-list=vlan40-camera protocol=udp dst-port=53 action=accept comment="VLAN40: Allow DNS"
add chain=input src-address-list=vlan40-camera protocol=tcp dst-port=53 action=accept comment="VLAN40: Allow DNS TCP"
add chain=input src-address-list=vlan40-camera protocol=udp dst-port=67 action=accept comment="VLAN40: Allow DHCP"

# Block Camera from initiating connections to other VLANs
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan10-trusted action=drop comment="VLAN40: Block Trusted VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan20-guest action=drop comment="VLAN40: Block Guest VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan30-iot action=drop comment="VLAN40: Block IoT VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan50-mgmt action=drop comment="VLAN40: Block MGMT VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan67-vpn action=drop comment="VLAN40: Block VPN VLAN"

# Block Camera from internet
add chain=forward src-address-list=vlan40-camera out-interface-list=WAN action=drop comment="VLAN40: Block internet (keep cameras local)"

# Block Camera from router management
add chain=input src-address-list=vlan40-camera action=drop comment="VLAN40: Block router access"

# ==========================================
# VLAN 50 (MGMT) RULES
# ==========================================
# Allow MGMT full access to all VLANs
add chain=forward src-address-list=vlan50-mgmt action=accept comment="VLAN50: Allow all access"

# Allow MGMT to manage router
add chain=input src-address-list=vlan50-mgmt action=accept comment="VLAN50: Allow router management"

# ==========================================
# VLAN 67 (VPN) RULES
# ==========================================
# Allow VPN to access Trusted, Camera, and MGMT VLANs
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan10-trusted action=accept comment="VLAN67: Allow Trusted access"
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan40-camera action=accept comment="VLAN67: Allow Camera access"
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan50-mgmt action=accept comment="VLAN67: Allow MGMT access"

# Allow VPN to internet
add chain=forward src-address-list=vlan67-vpn out-interface-list=WAN action=accept comment="VLAN67: Allow internet"

# Allow VPN DNS/DHCP to router
add chain=input src-address-list=vlan67-vpn protocol=udp dst-port=53 action=accept comment="VLAN67: Allow DNS"
add chain=input src-address-list=vlan67-vpn protocol=tcp dst-port=53 action=accept comment="VLAN67: Allow DNS TCP"
add chain=input src-address-list=vlan67-vpn protocol=udp dst-port=67 action=accept comment="VLAN67: Allow DHCP"

# Allow VPN limited router management (add specific ports if needed)
add chain=input src-address-list=vlan67-vpn protocol=tcp dst-port=22,8291 action=accept comment="VLAN67: Allow SSH/Winbox"

# ==========================================
# FINAL CATCH-ALL RULES
# ==========================================
# Log dropped traffic (optional - remove if too noisy)
add chain=forward action=log log-prefix="FW-DROP: " comment="Log dropped traffic"

# Drop everything else
add chain=forward action=drop comment="Drop all other traffic"
add chain=input action=drop comment="Drop all other input"
