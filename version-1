# MikroTik Inter-VLAN Firewall Rules
# Security-focused configuration with bandwidth limits

# ==========================================
# ADDRESS LISTS - For easy management
# ==========================================
/ip firewall address-list
add address=10.0.10.0/24 list=vlan10-trusted
add address=10.0.20.0/24 list=vlan20-guest
add address=10.0.30.0/24 list=vlan30-iot
add address=10.0.40.0/24 list=vlan40-camera
add address=10.0.50.0/24 list=vlan50-mgmt
add address=172.20.67.0/24 list=vlan67-vpn
add address=10.0.69.0/29 list=vlan69-dmz

# Media server addresses for VLAN 10 access
add address=10.0.50.10 list=media-servers comment="Plex"
add address=10.0.50.20 list=media-servers comment="JellyFin"
add address=10.0.50.30 list=media-servers comment="Overseerr"

# Backup management access
add address=10.0.10.50 list=trusted-admin comment="Backup SSH access"

# Bogon/Private IP addresses that should never appear on WAN
add address=0.0.0.0/8 list=bogons comment="RFC 1122 'This' Network"
add address=10.0.0.0/8 list=bogons comment="RFC 1918 Private"
add address=100.64.0.0/10 list=bogons comment="RFC 6598 Shared Address Space"
add address=127.0.0.0/8 list=bogons comment="RFC 1122 Loopback"
add address=169.254.0.0/16 list=bogons comment="RFC 3927 Link Local"
add address=172.16.0.0/12 list=bogons comment="RFC 1918 Private"
add address=192.0.0.0/24 list=bogons comment="RFC 6890 IETF Protocol"
add address=192.0.2.0/24 list=bogons comment="RFC 5737 Documentation"
add address=192.168.0.0/16 list=bogons comment="RFC 1918 Private"
add address=198.18.0.0/15 list=bogons comment="RFC 2544 Benchmarking"
add address=198.51.100.0/24 list=bogons comment="RFC 5737 Documentation"
add address=203.0.113.0/24 list=bogons comment="RFC 5737 Documentation"
add address=224.0.0.0/4 list=bogons comment="Multicast"
add address=240.0.0.0/4 list=bogons comment="Reserved"

# ==========================================
# FIREWALL RAW - Early packet processing for performance
# ==========================================
/ip firewall raw

# Drop packets from bogon addresses on WAN (before connection tracking)
add chain=prerouting in-interface-list=WAN src-address-list=bogons action=drop comment="Drop bogons from WAN"

# Accept established/related/untracked connections early (bypass connection tracking for performance)
add chain=prerouting action=accept connection-state=established,related,untracked comment="Accept established/related/untracked"

# ==========================================
# FIREWALL MANGLE - Connection tracking and marking
# ==========================================
/ip firewall mangle

# FastTrack - Offload established connections to hardware
add chain=prerouting action=accept connection-state=established,related connection-nat-state=!dstnat comment="FastTrack: Accept established"

# Mark connections from Guest VLAN for bandwidth limiting
add chain=prerouting src-address=10.0.20.0/24 action=mark-connection new-connection-mark=guest-conn comment="Mark Guest VLAN connections"
add chain=prerouting connection-mark=guest-conn action=mark-packet new-packet-mark=guest-upload comment="Mark Guest upload"
add chain=postrouting dst-address=10.0.20.0/24 action=mark-packet new-packet-mark=guest-download comment="Mark Guest download"

# Detect port scanning
add chain=prerouting protocol=tcp tcp-flags=fin,!syn,!rst,!psh,!ack,!urg action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: FIN"
add chain=prerouting protocol=tcp tcp-flags=fin,syn action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: SYN-FIN"
add chain=prerouting protocol=tcp tcp-flags=syn,rst action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: SYN-RST"
add chain=prerouting protocol=tcp tcp-flags=fin,psh,urg,!syn,!rst,!ack action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: FIN-PSH-URG"
add chain=prerouting protocol=tcp tcp-flags=fin,syn,rst,psh,ack,urg action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: ALL flags"
add chain=prerouting protocol=tcp tcp-flags=!fin,!syn,!rst,!psh,!ack,!urg action=add-src-to-address-list address-list=port-scanners address-list-timeout=2w comment="Port scan: NO flags"

# Drop packets from detected port scanners
add chain=prerouting src-address-list=port-scanners action=drop comment="Drop port scanners"

# Create queue tree for bandwidth limiting
/queue tree
add name=guest-download-limit packet-mark=guest-download parent=global max-limit=20M comment="Guest VLAN Download: 20Mbps"
add name=guest-upload-limit packet-mark=guest-upload parent=global max-limit=10M comment="Guest VLAN Upload: 10Mbps"

# ==========================================
# FIREWALL FILTER RULES
# ==========================================

# Drop invalid connections
/ip firewall filter
add chain=forward action=drop connection-state=invalid comment="Drop invalid connections"

# Accept established and related connections
add chain=forward action=accept connection-state=established,related comment="Accept established/related"

# ==========================================
# VLAN 10 (TRUSTED) RULES
# ==========================================
# Allow VLAN 10 to access media servers in MGMT VLAN
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=32400 action=accept comment="VLAN10: Allow Plex access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=8096 action=accept comment="VLAN10: Allow Jellyfin access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=media-servers protocol=tcp dst-port=5055 action=accept comment="VLAN10: Allow Overseerr access"

# Block VLAN 10 from rest of MGMT VLAN
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan50-mgmt action=drop comment="VLAN10: Block MGMT VLAN (except media servers)"

# Allow VLAN 10 to access IoT, Camera, and VPN VLANs
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan30-iot action=accept comment="VLAN10: Allow IoT access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan40-camera action=accept comment="VLAN10: Allow Camera access"
add chain=forward src-address-list=vlan10-trusted dst-address-list=vlan67-vpn action=accept comment="VLAN10: Allow VPN access"

# Allow VLAN 10 to internet
add chain=forward src-address-list=vlan10-trusted out-interface-list=WAN action=accept comment="VLAN10: Allow internet"

# Allow VLAN 10 DNS/DHCP to router
add chain=input src-address-list=vlan10-trusted protocol=udp dst-port=53 action=accept comment="VLAN10: Allow DNS"
add chain=input src-address-list=vlan10-trusted protocol=tcp dst-port=53 action=accept comment="VLAN10: Allow DNS TCP"
add chain=input src-address-list=vlan10-trusted protocol=udp dst-port=67 action=accept comment="VLAN10: Allow DHCP"

# Block VLAN 10 from managing router
add chain=input src-address-list=vlan10-trusted action=drop comment="VLAN10: Block router management"

# ==========================================
# VLAN 20 (GUEST) RULES
# ==========================================
# Allow Guest VLAN DNS/DHCP to router
add chain=input src-address-list=vlan20-guest protocol=udp dst-port=53 action=accept comment="VLAN20: Allow DNS"
add chain=input src-address-list=vlan20-guest protocol=tcp dst-port=53 action=accept comment="VLAN20: Allow DNS TCP"
add chain=input src-address-list=vlan20-guest protocol=udp dst-port=67 action=accept comment="VLAN20: Allow DHCP"

# Block Guest from all VLANs
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan10-trusted action=drop comment="VLAN20: Block Trusted VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan30-iot action=drop comment="VLAN20: Block IoT VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan40-camera action=drop comment="VLAN20: Block Camera VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan50-mgmt action=drop comment="VLAN20: Block MGMT VLAN"
add chain=forward src-address-list=vlan20-guest dst-address-list=vlan67-vpn action=drop comment="VLAN20: Block VPN VLAN"

# Allow Guest to internet only (bandwidth limited via queue)
add chain=forward src-address-list=vlan20-guest out-interface-list=WAN action=accept comment="VLAN20: Allow internet (bandwidth limited)"

# Block Guest from router management
add chain=input src-address-list=vlan20-guest action=drop comment="VLAN20: Block router access"

# ==========================================
# VLAN 30 (IoT) RULES
# ==========================================
# Allow IoT VLAN DNS/DHCP to router
add chain=input src-address-list=vlan30-iot protocol=udp dst-port=53 action=accept comment="VLAN30: Allow DNS"
add chain=input src-address-list=vlan30-iot protocol=tcp dst-port=53 action=accept comment="VLAN30: Allow DNS TCP"
add chain=input src-address-list=vlan30-iot protocol=udp dst-port=67 action=accept comment="VLAN30: Allow DHCP"

# Block IoT from all VLANs
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan10-trusted action=drop comment="VLAN30: Block Trusted VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan20-guest action=drop comment="VLAN30: Block Guest VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan40-camera action=drop comment="VLAN30: Block Camera VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan50-mgmt action=drop comment="VLAN30: Block MGMT VLAN"
add chain=forward src-address-list=vlan30-iot dst-address-list=vlan67-vpn action=drop comment="VLAN30: Block VPN VLAN"

# Allow IoT to internet only
add chain=forward src-address-list=vlan30-iot out-interface-list=WAN action=accept comment="VLAN30: Allow internet only"

# Block IoT from router management
add chain=input src-address-list=vlan30-iot action=drop comment="VLAN30: Block router access"

# ==========================================
# VLAN 40 (CAMERA) RULES
# ==========================================
# Allow Camera VLAN DNS/DHCP to router
add chain=input src-address-list=vlan40-camera protocol=udp dst-port=53 action=accept comment="VLAN40: Allow DNS"
add chain=input src-address-list=vlan40-camera protocol=tcp dst-port=53 action=accept comment="VLAN40: Allow DNS TCP"
add chain=input src-address-list=vlan40-camera protocol=udp dst-port=67 action=accept comment="VLAN40: Allow DHCP"

# Block Camera from initiating connections to other VLANs
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan10-trusted action=drop comment="VLAN40: Block Trusted VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan20-guest action=drop comment="VLAN40: Block Guest VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan30-iot action=drop comment="VLAN40: Block IoT VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan50-mgmt action=drop comment="VLAN40: Block MGMT VLAN"
add chain=forward src-address-list=vlan40-camera dst-address-list=vlan67-vpn action=drop comment="VLAN40: Block VPN VLAN"

# Block Camera from internet
add chain=forward src-address-list=vlan40-camera out-interface-list=WAN action=drop comment="VLAN40: Block internet (keep cameras local)"

# Block Camera from router management
add chain=input src-address-list=vlan40-camera action=drop comment="VLAN40: Block router access"

# ==========================================
# VLAN 50 (MGMT) RULES
# ==========================================
# Allow MGMT full access to all VLANs
add chain=forward src-address-list=vlan50-mgmt action=accept comment="VLAN50: Allow all access"

# Allow MGMT to manage router
add chain=input src-address-list=vlan50-mgmt action=accept comment="VLAN50: Allow router management"

# ==========================================
# VLAN 67 (VPN) RULES
# ==========================================
# Allow VPN to access Trusted, Camera, and MGMT VLANs
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan10-trusted action=accept comment="VLAN67: Allow Trusted access"
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan40-camera action=accept comment="VLAN67: Allow Camera access"
add chain=forward src-address-list=vlan67-vpn dst-address-list=vlan50-mgmt action=accept comment="VLAN67: Allow MGMT access"

# Allow VPN to internet
add chain=forward src-address-list=vlan67-vpn out-interface-list=WAN action=accept comment="VLAN67: Allow internet"

# Allow VPN DNS/DHCP to router
add chain=input src-address-list=vlan67-vpn protocol=udp dst-port=53 action=accept comment="VLAN67: Allow DNS"
add chain=input src-address-list=vlan67-vpn protocol=tcp dst-port=53 action=accept comment="VLAN67: Allow DNS TCP"
add chain=input src-address-list=vlan67-vpn protocol=udp dst-port=67 action=accept comment="VLAN67: Allow DHCP"

# Allow VPN limited router management (add specific ports if needed)
add chain=input src-address-list=vlan67-vpn protocol=tcp dst-port=22,8291 action=accept comment="VLAN67: Allow SSH/Winbox"

# ==========================================
# VLAN 69 (DMZ) RULES
# ==========================================
# Allow DMZ VLAN DNS/DHCP to router
add chain=input src-address-list=vlan69-dmz protocol=udp dst-port=53 action=accept comment="VLAN69: Allow DNS"
add chain=input src-address-list=vlan69-dmz protocol=tcp dst-port=53 action=accept comment="VLAN69: Allow DNS TCP"
add chain=input src-address-list=vlan69-dmz protocol=udp dst-port=67 action=accept comment="VLAN69: Allow DHCP"

# Block DMZ from router management
add chain=input src-address-list=vlan69-dmz action=drop comment="VLAN69: Block router access"

# Block remaining input to router
add chain=input action=drop comment="Drop all other input to router"

# ==========================================
# FORWARD CHAIN - Traffic between networks
# ==========================================

# Drop invalid connections
add chain=forward action=drop connection-state=invalid comment="Drop invalid connections"

# Accept established and related connections
add chain=forward action=accept connection-state=established,related comment="Accept established/related"

# FastTrack established connections (hardware offload for performance)
add chain=forward action=fasttrack-connection connection-state=established,related hw-offload=yes comment="FastTrack established connections"

# Drop packets from port scanners
add chain=forward src-address-list=port-scanners action=drop comment="Drop port scanners"

# Block hairpin routing (prevent VLAN bypass via WAN)
add chain=forward connection-state=new connection-nat-state=!dstnat in-interface-list=!WAN out-interface-list=!WAN action=drop comment="Block inter-VLAN hairpin"

# ==========================================
# VLAN 69 (DMZ) RULES
# ==========================================
# Allow MGMT VLAN to access DMZ
add chain=forward src-address-list=vlan50-mgmt dst-address-list=vlan69-dmz action=accept comment="VLAN69: Allow MGMT access"

# Block DMZ from initiating connections to other VLANs
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan10-trusted action=drop comment="VLAN69: Block Trusted VLAN"
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan20-guest action=drop comment="VLAN69: Block Guest VLAN"
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan30-iot action=drop comment="VLAN69: Block IoT VLAN"
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan40-camera action=drop comment="VLAN69: Block Camera VLAN"
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan50-mgmt action=drop comment="VLAN69: Block MGMT VLAN"
add chain=forward src-address-list=vlan69-dmz dst-address-list=vlan67-vpn action=drop comment="VLAN69: Block VPN VLAN"

# Allow DMZ to internet
add chain=forward src-address-list=vlan69-dmz out-interface-list=WAN action=accept comment="VLAN69: Allow internet"

# ==========================================
# FINAL CATCH-ALL RULES
# ==========================================
# Log dropped traffic (optional - remove if too noisy)
add chain=forward action=log log-prefix="FW-DROP: " comment="Log dropped traffic"

# Drop everything else
add chain=forward action=drop comment="Drop all other traffic"
add chain=input action=drop comment="Drop all other input"

# ==========================================
# NEIGHBOR DISCOVERY - Disable on untrusted VLANs
# ==========================================
/ip neighbor discovery-settings
set discover-interface-list=!dynamic

# Disable MAC-Telnet and Winbox discovery on untrusted interfaces
/tool mac-server
set allowed-interface-list=none

/tool mac-server mac-winbox
set allowed-interface-list=none

/tool mac-server ping
set enabled=no

# Enable MAC server only on ether5 (management port)
/tool mac-server
add interface=ether5

/tool mac-server mac-winbox
add interface=ether5

# ==========================================
# NAT RULES - Port Forwarding for DMZ
# ==========================================
/ip firewall nat

# Port forward HTTP (80) to Nginx Proxy Manager in DMZ
add chain=dstnat in-interface-list=WAN protocol=tcp dst-port=80 action=dst-nat to-addresses=10.0.69.2 to-ports=1880 comment="DMZ: Forward HTTP to Nginx Proxy Manager"

# Port forward HTTPS (443) to Nginx Proxy Manager in DMZ  
add chain=dstnat in-interface-list=WAN protocol=tcp dst-port=443 action=dst-nat to-addresses=10.0.69.2 to-ports=18443 comment="DMZ: Forward HTTPS to Nginx Proxy Manager"

# Masquerade for internet access
add chain=srcnat out-interface-list=WAN action=masquerade comment="Masquerade to internet"
